<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --bg-dark: #1C1C28; 
            --terminal-border: #3A3A4A; 
            --text-main: #C9D1D9; 
            --text-prompt: #8B949E; 
            --neon-success: #4CAF50; 
            --neon-error: #FF6B6B; 
            --neon-title: #7986CB; 
            --neon-highlight: #74D4FF; 
            --font-main: 'Fira Code', monospace; 
        }
        
        body {
            font-family: var(--font-main);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: var(--bg-dark); 
            color: var(--text-main); 
            overflow: hidden; 
            font-size: 16px; 
        }
        
        .terminal-container {
            width: 90%;
            max-width: 750px; 
            padding: 30px; 
            background-color: #242436; 
            border: 1px solid var(--terminal-border);
            border-radius: 8px; 
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5), 0 0 5px rgba(121, 134, 203, 0.2); 
            text-align: left;
            opacity: 0; 
            animation: fadeIn 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; 
            transition: box-shadow 0.3s ease;
        }

        .terminal-container:hover {
            box-shadow: 0 0 25px rgba(0, 0, 0, 0.7), 0 0 10px rgba(121, 134, 203, 0.4);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); } 
            to { opacity: 1; transform: scale(1); } 
        }

        .output-history {
            min-height: 50px;
            max-height: 70vh;
            overflow-y: auto; 
            font-size: 1rem;
            line-height: 1.6;
            padding-bottom: 10px;
            margin-bottom: 10px;
            white-space: pre-wrap; 
        }
        
        .output-history::-webkit-scrollbar {
            width: 8px;
        }
        .output-history::-webkit-scrollbar-thumb {
            background-color: var(--terminal-border);
            border-radius: 10px;
        }
        .output-history::-webkit-scrollbar-track {
            background-color: var(--bg-dark);
        }

        .prompt-line {
            display: flex;
            gap: 10px;
            font-size: 1.1rem;
            color: var(--text-prompt);
            margin-top: 5px;
        }

        .prompt-symbol {
            font-weight: bold;
            color: var(--neon-highlight); 
        }

        .cursor {
            display: inline-block;
            width: 8px; 
            height: 1.2em;
            background-color: var(--neon-highlight); 
            animation: blink 0.8s step-start infinite; 
            margin-left: 2px;
            vertical-align: middle;
            border-radius: 1px;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }

        .hidden-input {
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%;
            height: 100%;
            opacity: 0; 
            z-index: -1; 
        }
        
        .message-success { color: var(--neon-success); }
        .message-error { color: var(--neon-error); }
        .message-secondary { color: var(--text-prompt); }
        .message-title { 
            color: var(--neon-title); 
            font-weight: bold; 
            text-shadow: 0 0 5px rgba(121, 134, 203, 0.5); 
            margin-top: 10px;
            margin-bottom: 5px;
        }
        
        .typing {
            overflow: hidden; 
            white-space: nowrap; 
            width: 0; 
            border-right: none; 
            animation: typing 1.5s steps(30, end) forwards;
        }
        
        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }
    </style>
</head>
<body>

    <div class="terminal-container" id="terminalContainer">
        
        <div class="output-history" id="output">
            </div>

        <div class="prompt-line">
            <span class="prompt-symbol" id="promptSymbol">ACCESS_01 $</span>
            <div id="inputDisplay">
                <span id="maskedInput"></span><span id="cursor" class="cursor"></span>
            </div>
        </div>

        <input 
            type="password" 
            id="passwordInput" 
            class="hidden-input"
            autofocus
            autocomplete="off"
            autocorrect="off"
            spellcheck="false"
        >
    </div>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCba6M_spBXvuG91Zn-XWJ4bSTX6vNcST0",
            authDomain: "index-68220.firebaseapp.com",
            databaseURL: "https://index-68220-default-rtdb.firebaseio.com",
            projectId: "index-68220",
            storageBucket: "index-68220.firebasestorage.app",
            messagingSenderId: "633087068802",
            appId: "1:633087068802:web:f8aa1f2ef9c00b99d1429b",
            measurementId: "G-2VQCRFJQCM"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        const input = document.getElementById('passwordInput');
        const output = document.getElementById('output');
        const maskedInput = document.getElementById('maskedInput');
        const promptSymbol = document.getElementById('promptSymbol');
        const terminalContainer = document.getElementById('terminalContainer');
        const REDIRECT_URL = 'beranda.html'; 

        let storedHash = null; 
        let isAuthenticating = false;
        let currentStage = 1; 
        const MAX_FAKE_STAGES = 3; 
        
        const FULL_INIT_LOG = [
            { type: 'title', response: ">>> ACCESS CONTROL PROTOCOL V4.1 INITIATED" },
            { type: 'secondary', response: "--------------------------------------------------------" },
            
            
            { type: 'title', response: "PHASE 1: SYSTEM CORE INITIALIZATION" },
            { type: 'secondary', response: " -> Initializing Secure Firmware (v4.1.2)... [OK]" },
            { type: 'secondary', response: " -> Scanning Hardware: Temp(34Â°C). Drive(Online). SecureMode(Active)." },
            { type: 'success', response: " -> Loading Critical Modules: [Network_S], [Enc_256], [Task_Mgr]." },
            
            { type: 'title', response: "PHASE 2: NETWORK & DATA PROTOCOL CHECK" },
            { type: 'secondary', response: " -> Checking network latency to Primary Server (5ms)." },
            { type: 'success', response: " -> Secure channel established (TLS 1.3/AES-256)." },
            { type: 'secondary', response: " -> Preparing key buffer for next stage." },
            
            { type: 'title', response: "PHASE 3: LOCAL CACHE VERIFICATION" },
            { type: 'secondary', response: " -> Verifying credentials against local encrypted cache..." },
            { type: 'error', response: " -> Cache integrity check FAILED (0xCD12). Forcing manual input." },
            { type: 'error', response: " -> WARNING: Manual input required. Proceed to next stage." },
            { type: 'success', response: " -> System ready. Proceed to **STAGE-4**." },
        ];
        
        const FAILURE_LOG = [
            { type: 'title', response: "!!! AUTHENTICATION FAILURE ALERT !!!" },
            { type: 'error', response: " -> Key rejected. Invalid sequence or hash mismatch." },
            { type: 'secondary', response: " -> Running emergency diagnostics and key reinitialization..." },
            { type: 'secondary', response: " -> Integrity check: PASS. Attempt logged." },
            { type: 'error', response: " -> Input buffer cleared. Awaiting new Final Key." },
        ];

        const LOG_BREAKPOINTS = [6, 10, 15]; 

        const DISPLAY_CODES = [
            "LOAD_MODULE", "CHECK_INIT", "VERIFY_CERT", "SET_FLAG", 
            "CALC_SUM", "EXEC_PROC", "DECRYPT_KEY", "NETWORK_PING",
            "SYNC_TIME", "READ_BUFFER", "FINAL_AUTH", "GET_HASH",
        ];

        async function sha256Hex(str) {
            const enc = new TextEncoder().encode(str);
            const digest = await crypto.subtle.digest('SHA-256', enc);
            return Array.from(new Uint8Array(digest)).map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        function appendLogLine(responseText, className = '') {
            const responseLine = document.createElement('div');
            responseLine.textContent = responseText;
            responseLine.className = className;
            output.appendChild(responseLine);
            output.scrollTop = output.scrollHeight; 
        }

        function appendTypingLine(responseText, className = '') {
            const responseLine = document.createElement('div');
            responseLine.innerHTML = `<span class="typing">${responseText}</span>`;
            responseLine.className = className;
            output.appendChild(responseLine);
            output.scrollTop = output.scrollHeight; 
            
            setTimeout(() => {
                const typingSpan = responseLine.querySelector('.typing');
                if (typingSpan) {
                    typingSpan.style.width = 'auto'; 
                }
            }, 1500); 
        }

        function appendPromptToHistory(promptText) {
            const promptLine = document.createElement('div');
            promptLine.textContent = `${promptSymbol.textContent} ${promptText}`;
            promptLine.className = 'message-secondary';
            output.appendChild(promptLine);
            output.scrollTop = output.scrollHeight; 
        }
        
        function updateMaskedInput(realValue) {
            const length = realValue.length;
            let displayedCode = "";
            
            for (let i = 0; i < length; i++) {
                displayedCode += DISPLAY_CODES[i % DISPLAY_CODES.length] + ' ';
            }
            
            maskedInput.textContent = displayedCode.trim();
        }

        async function runStageLog(logArray, onCompleteCallback) {
            isAuthenticating = true; 
            let delay = 70; 
            
            for (let i = 0; i < logArray.length; i++) {
                setTimeout(() => {
                    const log = logArray[i];
                    appendLogLine(log.response, `message-${log.type}`);
                    
                    if (i === logArray.length - 1) {
                        onCompleteCallback();
                    }
                }, delay * i); 
            }
        }

        function welcomeSequence() {
            setTimeout(() => {
                appendTypingLine(FULL_INIT_LOG[0].response, `message-${FULL_INIT_LOG[0].type}`); 
                
                setTimeout(() => {
                    appendLogLine(FULL_INIT_LOG[1].response, `message-${FULL_INIT_LOG[1].type}`);
                    
                    setTimeout(() => {
                        appendTypingLine("System Ready. Press ENTER to begin **STAGE 1**.", 'message-success');
                        isAuthenticating = false;
                        input.focus(); 
                    }, 500); 
                }, 1600); 

            }, 1000); 
        }

        async function preloadPasswordHash() {
            try {
                const snapshot = await db.ref('real/passwordHash').once('value');
                storedHash = snapshot.val();

                if (!storedHash) {
                    appendLogLine("FATAL ERROR: Failed to retrieve hash.", 'message-error');
                } else {
                    welcomeSequence();
                }

            } catch (error) {
                console.error('Error saat memuat sandi:', error);
                appendLogLine("FATAL ERROR: Network connection failed.", 'message-error');
            }
        }

        input.addEventListener('input', () => {
            updateMaskedInput(input.value); 
        });
        
        input.addEventListener('keydown', async (event) => {
            if (event.key !== 'Enter' || isAuthenticating) return;
            
            event.preventDefault();
            
            const enteredText = input.value.trim();
            const displayedText = maskedInput.textContent;
            
            appendPromptToHistory(displayedText || (currentStage <= MAX_FAKE_STAGES ? 'INIT_EXECUTE' : 'ENTER_KEY'));

            input.value = '';
            updateMaskedInput('');

            if (currentStage <= MAX_FAKE_STAGES) {
                
                const currentLogIndex = currentStage === 1 ? 2 : LOG_BREAKPOINTS[currentStage - 2];
                const nextLogIndex = LOG_BREAKPOINTS[currentStage - 1];
                
                const stageLog = FULL_INIT_LOG.slice(currentLogIndex, nextLogIndex);

                runStageLog(stageLog, () => {
                    currentStage++; 
                    if (currentStage <= MAX_FAKE_STAGES) {
                        promptSymbol.textContent = `ACCESS_0${currentStage} $`;
                        appendLogLine(`System Ready. Press ENTER to begin **STAGE ${currentStage}** command input.`, 'message-success');
                    } else {
                        promptSymbol.textContent = 'AUTH_FINAL $'; 
                        appendLogLine("Access Control Activated. Enter **FINAL KEY**.", 'message-title');
                    }
                    isAuthenticating = false; 
                    input.focus();
                });

            } else {
                
                if (enteredText.length === 0) {
                    appendLogLine("ERROR: Final Access Key is required.", 'message-error');
                    isAuthenticating = false;
                    input.focus();
                    return;
                }

                isAuthenticating = true;
                appendLogLine("Executing Final Authentication (SHA-256)...", 'message-secondary');
                
                const inputHash = await sha256Hex(enteredText);
                
                if (inputHash === storedHash) {
                    
                    appendLogLine('ACCESS GRANTED. Redirecting to secured environment...', 'message-success');
                    setTimeout(() => {
                        window.location.href = REDIRECT_URL;
                    }, 1000); 

                } else {
                    
                    runStageLog(FAILURE_LOG, () => {
                        promptSymbol.textContent = 'AUTH_FINAL $'; 
                        isAuthenticating = false; 
                        input.focus();
                    });
                }
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            preloadPasswordHash(); 
            
            document.addEventListener('click', () => {
                input.focus();
            });
        });
    </script>

</body>
</html>
