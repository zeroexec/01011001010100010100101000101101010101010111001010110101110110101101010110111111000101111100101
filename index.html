<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Akses Bertahap</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --bg-dark: black; 
            --text-main: #00FF00; 
            --text-secondary: #008000; 
            --text-error: #FF0000; 
            --text-success: #00FFFF; 
            --font-main: 'Roboto Mono', monospace; 
        }
        
        body {
            font-family: var(--font-main);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: var(--bg-dark); 
            color: var(--text-main); 
            overflow: hidden; 
        }
        
        .terminal-container {
            width: 90%;
            max-width: 600px; 
            padding: 20px 10px; 
            text-align: left;
            /* --- ANIMASI MASUK BARU --- */
            opacity: 0; 
            animation: fadeIn 1.5s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* ------------------------- */

        .output-history {
            min-height: 50px;
            max-height: 80vh;
            overflow-y: scroll; 
            font-size: 1.1rem;
            line-height: 1.4;
            padding-bottom: 5px;
            
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .output-history::-webkit-scrollbar {
            display: none;
        }

        .prompt-line {
            display: flex;
            gap: 10px;
            font-size: 1.1rem;
            color: var(--text-main);
        }

        .prompt-symbol {
            font-weight: bold;
        }

        .cursor {
            display: inline-block;
            width: 8px; 
            height: 1.2em;
            background-color: var(--text-main); 
            animation: blink 1s step-start infinite;
            margin-left: 2px;
            vertical-align: middle;
        }

        @keyframes blink {
            50% { opacity: 0; }
        }

        .hidden-input {
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%;
            height: 100%;
            opacity: 0; 
            z-index: -1; 
        }
        
        .message-success { color: var(--text-success); }
        .message-error { color: var(--text-error); }
        .message-secondary { color: var(--text-secondary); }
        .message-title { color: white; font-weight: bold; }

        /* --- Gaya Efek Mengetik BARU --- */
        .typing {
            overflow: hidden; /* Pastikan teks tidak terlihat sebelum diketik */
            white-space: nowrap; /* Teks tetap dalam satu baris */
            width: 0; /* Lebar awal 0 */
            border-right: 0.15em solid white; /* Efek kursor mengetik */
            animation: typing 1.5s steps(30, end) forwards;
        }
        
        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }
        /* -------------------------------- */
    </style>
</head>
<body>

    <div class="terminal-container" id="terminalContainer">
        
        <div class="output-history" id="output">
            </div>

        <div class="prompt-line">
            <span class="prompt-symbol" id="promptSymbol">STAGE-1 $</span>
            <div id="inputDisplay">
                <span id="maskedInput"></span><span id="cursor" class="cursor"></span>
            </div>
        </div>

        <input 
            type="password" 
            id="passwordInput" 
            class="hidden-input"
            autofocus
            autocomplete="off"
            autocorrect="off"
            spellcheck="false"
        >
    </div>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCba6M_spBXvuG91Zn-XWJ4bSTX6vNcST0",
            authDomain: "index-68220.firebaseapp.com",
            databaseURL: "https://index-68220-default-rtdb.firebaseio.com",
            projectId: "index-68220",
            storageBucket: "index-68220.firebasestorage.app",
            messagingSenderId: "633087068802",
            appId: "1:633087068802:web:f8aa1f2ef9c00b99d1429b",
            measurementId: "G-2VQCRFJQCM"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const input = document.getElementById('passwordInput');
        const output = document.getElementById('output');
        const maskedInput = document.getElementById('maskedInput');
        const promptSymbol = document.getElementById('promptSymbol');
        const terminalContainer = document.getElementById('terminalContainer');
        const REDIRECT_URL = 'beranda.html'; 

        let storedHash = null; 
        let isAuthenticating = false;
        let currentStage = 1; 
        const MAX_FAKE_STAGES = 3; 
        
        const FULL_INIT_LOG = [
            { type: 'title', response: "// SYSTEM: Welcome Back Aji" },
            { type: 'secondary', response: "--------------------------------------------------------" },
            
            // Stage 1 Log
            { type: 'title', response: "PHASE 1: FIRMWARE INITIALIZATION" },
            { type: 'secondary', response: "  -> Initializing Core Firmware v3.0.1... [OK]" },
            { type: 'secondary', response: "  -> Scanning hardware: CPU Temperature (34Â°C). Drive Status (Online)." },
            { type: 'success', response: "  -> Starting critical services: [Network], [Encryption]." },
            // Stage 2 Log
            { type: 'title', response: "PHASE 2: NETWORK & PROTOCOL CHECK" },
            { type: 'secondary', response: "  -> Loading Kernel Modules: fs_sync.dll, net_sec.sys, task_mgr.exe..." },
            { type: 'success', response: "  -> Ping latency check to server 10.0.0.1: 5ms." },
            { type: 'success', response: "  -> Establishing secure channel... Done." },
            // Stage 3 Log
            { type: 'title', response: "PHASE 3: ACCESS VERIFICATION" },
            { type: 'secondary', response: "  -> Verifying credentials against local cache..." },
            { type: 'error', response: "  -> Cache Checksum Mismatch! Local data compromised." },
            { type: 'error', response: "  -> WARNING: Forcing manual authentication via console." },
            { type: 'success', response: "  -> System is ready for Stage 2 command input." },
        ];
        
        const FAILURE_LOG = [
            { type: 'title', response: "SECURITY ALERT: AUTHENTICATION FAILURE" },
            { type: 'error', response: "  -> Key rejected. Protocol breach attempt detected." },
            { type: 'secondary', response: "  -> Running emergency diagnostics..." },
            { type: 'secondary', response: "  -> System integrity check: PASS." },
            { type: 'error', response: "  -> Intrusion attempt logged. Reinitializing key input buffer." },
            { type: 'secondary', response: "  -> Awaiting new key. Input required." },
        ];

        const LOG_BREAKPOINTS = [6, 10, 15]; 

        const DISPLAY_CODES = [
            "LOAD_MODULE", "CHECK_INIT", "VERIFY_CERT", "SET_FLAG", 
            "CALC_SUM", "EXEC_PROC", "DECRYPT_KEY", "NETWORK_PING",
            "SYNC_TIME", "READ_BUFFER", "FINAL_AUTH", "GET_HASH",
        ];
        
        async function sha256Hex(str) {
            const enc = new TextEncoder().encode(str);
            const digest = await crypto.subtle.digest('SHA-256', enc);
            return Array.from(new Uint8Array(digest)).map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        function appendLogLine(responseText, className = '') {
            const responseLine = document.createElement('div');
            responseLine.textContent = responseText;
            responseLine.className = className;
            output.appendChild(responseLine);
            output.scrollTop = output.scrollHeight; 
        }

        // FUNGSI BARU: Untuk menambahkan baris dengan efek mengetik
        function appendTypingLine(responseText, className = '') {
            const responseLine = document.createElement('div');
            // Bungkus teks di dalam span dengan class 'typing'
            responseLine.innerHTML = `<span class="typing">${responseText}</span>`;
            responseLine.className = className;
            output.appendChild(responseLine);
            output.scrollTop = output.scrollHeight; 
            
            // Hapus kelas 'typing' setelah animasi selesai
            setTimeout(() => {
                const typingSpan = responseLine.querySelector('.typing');
                if (typingSpan) {
                    typingSpan.style.width = 'auto'; // Tampilkan penuh
                    typingSpan.style.borderRight = 'none'; // Hapus kursor
                }
            }, 1500); // 1.5s adalah durasi animasi di CSS
        }

        function appendPromptToHistory(promptText) {
            const promptLine = document.createElement('div');
            promptLine.textContent = `${promptSymbol.textContent} ${promptText}`;
            promptLine.className = 'message-secondary';
            output.appendChild(promptLine);
            output.scrollTop = output.scrollHeight; 
        }
        
        function updateMaskedInput(realValue) {
            const length = realValue.length;
            let displayedCode = "";
            
            for (let i = 0; i < length; i++) {
                displayedCode += DISPLAY_CODES[i % DISPLAY_CODES.length] + ' ';
            }
            
            maskedInput.textContent = displayedCode.trim();
        }

        async function runStageLog(logArray, onCompleteCallback) {
            isAuthenticating = true; 
            let delay = 50; 
            
            for (let i = 0; i < logArray.length; i++) {
                setTimeout(() => {
                    const log = logArray[i];
                    appendLogLine(log.response, `message-${log.type}`);
                    
                    if (i === logArray.length - 1) {
                        onCompleteCallback();
                    }
                }, delay * i); 
            }
        }

        function welcomeSequence() {
            // Setelah kontainer muncul (1.5 detik), mulai mengetik pesan
            setTimeout(() => {
                // Pesan Selamat Datang Aji (Typing Effect)
                appendTypingLine(FULL_INIT_LOG[0].response, `message-${FULL_INIT_LOG[0].type}`);
                
                // Pesan Garis Pemisah (Normal)
                setTimeout(() => {
                    appendLogLine(FULL_INIT_LOG[1].response, `message-${FULL_INIT_LOG[1].type}`);
                    
                    // Pesan System Ready (Typing Effect)
                    setTimeout(() => {
                        appendTypingLine("System Ready. Press ENTER to begin sequence.", 'message-success');
                        isAuthenticating = false;
                        input.focus(); 
                    }, 500); // Tunggu 0.5 detik setelah garis

                }, 1600); // Tunggu 1.6 detik (setelah typing welcome selesai)

            }, 1000); // Mulai 1 detik setelah halaman load (saat fade-in berjalan)
        }

        async function preloadPasswordHash() {
            try {
                const snapshot = await db.ref('real/passwordHash').once('value');
                storedHash = snapshot.val();

                if (!storedHash) {
                    appendLogLine("FATAL ERROR: Failed to retrieve hash.", 'message-error');
                } else {
                    welcomeSequence();
                }

            } catch (error) {
                console.error('Error saat memuat sandi:', error);
                appendLogLine("FATAL ERROR: Network connection failed.", 'message-error');
            }
        }

        // --- Event Listeners ---

        input.addEventListener('input', () => {
            updateMaskedInput(input.value);
        });
        
        input.addEventListener('keydown', async (event) => {
            if (event.key !== 'Enter' || isAuthenticating) return;
            
            event.preventDefault();
            
            const enteredText = input.value.trim();
            const displayedText = maskedInput.textContent;
            
            appendPromptToHistory(displayedText || 'EXECUTE');

            input.value = '';
            updateMaskedInput('');

            if (currentStage <= MAX_FAKE_STAGES) {
                // --- TAHAP PALSU (1, 2, 3) ---
                
                const currentLogIndex = currentStage === 1 ? 2 : LOG_BREAKPOINTS[currentStage - 2];
                const nextLogIndex = LOG_BREAKPOINTS[currentStage - 1];
                
                const stageLog = FULL_INIT_LOG.slice(currentLogIndex, nextLogIndex);

                runStageLog(stageLog, () => {
                    currentStage++; 
                    if (currentStage <= MAX_FAKE_STAGES) {
                        promptSymbol.textContent = `STAGE-${currentStage} $`;
                    } else {
                        promptSymbol.textContent = 'AUTH $'; 
                        appendLogLine("Access Control Activated. Enter Final Key.", 'message-title');
                    }
                    isAuthenticating = false; 
                    input.focus();
                });

            } else {
                // --- TAHAP NYATA (4) ---
                
                if (enteredText.length === 0) {
                    appendLogLine("ERROR: Access key required.", 'message-error');
                    return;
                }

                isAuthenticating = true;
                appendLogLine("Executing Final Authentication...", 'message-secondary');
                
                const inputHash = await sha256Hex(enteredText);
                
                if (inputHash === storedHash) {
                    // BERHASIL MASUK
                    appendLogLine('ACCESS GRANTED. Redirecting to secured environment...', 'message-success');
                    setTimeout(() => {
                        window.location.href = REDIRECT_URL;
                    }, 1000); 

                } else {
                    // GAGAL, RUN LOG KEGAGALAN PANJANG
                    runStageLog(FAILURE_LOG, () => {
                        promptSymbol.textContent = 'AUTH $'; 
                        isAuthenticating = false; 
                        input.focus();
                    });
                }
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            preloadPasswordHash(); 
            
            document.addEventListener('click', () => {
                input.focus();
            });
        });
    </script>

</body>
</html>
